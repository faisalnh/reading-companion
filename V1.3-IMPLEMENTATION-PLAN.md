# v1.3 Implementation Plan: Polish & Stability

> **Version:** 1.3.0  
> **Started:** November 25, 2025  
> **Target Completion:** Q1 2026  
> **Focus:** Testing, Type Safety, Security Hardening

---

## Overview

Version 1.3 focuses on code quality, stability, and security improvements without adding new features.

## Goals

1. **Automated Testing**: Achieve 60%+ code coverage
2. **Type Safety**: Eliminate all TypeScript `any` types (14 found)
3. **Security Hardening**: Add rate limiting and CAPTCHA protection
4. **Code Quality**: Improve error handling and documentation

---

## Phase 1: Testing Infrastructure (Week 1-2)

### Setup
- [ ] Install and configure Vitest (faster than Jest for Vite/Next.js)
- [ ] Install React Testing Library
- [ ] Configure test environment and mocks
- [ ] Set up coverage reporting
- [ ] Create test utilities and helpers

### Test Strategy
- **Unit Tests**: Utilities, helpers, pure functions
- **Component Tests**: UI components with RTL
- **Integration Tests**: API routes and server actions
- **E2E Tests**: Critical user flows (future phase)

### Priority Test Targets
1. **Authentication flows** (login, signup, OAuth)
2. **Book upload and processing** (librarian actions)
3. **Reading progress tracking** (student features)
4. **Quiz generation and grading** (AI features)
5. **Role-based access control** (RLS policies)

---

## Phase 2: TypeScript Type Safety (Week 2-3)

### Current State: 14 `any` Types Found

#### High Priority (Data Handling)
1. `src/app/(dashboard)/dashboard/librarian/actions.ts:756` - Quiz forEach loop
2. `src/app/(dashboard)/dashboard/librarian/actions.ts:920` - Update data object
3. `src/app/(dashboard)/dashboard/teacher/actions.ts:288` - Assignments map
4. `src/lib/pdf-extractor.ts:80` - PDF text items map

#### Medium Priority (Component Props)
5. `src/app/(dashboard)/dashboard/student/classrooms/[classId]/page.tsx:72` - Book rows
6. `src/app/(dashboard)/dashboard/student/classrooms/[classId]/page.tsx:103` - Progress data
7. `src/app/(dashboard)/dashboard/student/classrooms/[classId]/page.tsx:119` - Quiz assignments
8. `src/app/(dashboard)/dashboard/student/classrooms/[classId]/page.tsx:151` - Quiz attempts
9. `src/app/(dashboard)/dashboard/student/page.tsx:54` - Class book data
10. `src/app/(dashboard)/dashboard/student/page.tsx:77` - Class rows
11. `src/app/(dashboard)/dashboard/teacher/classrooms/[classId]/page.tsx:115` - Reading entries
12. `src/app/(dashboard)/dashboard/teacher/classrooms/[classId]/page.tsx:154` - Quiz attempts
13. `src/app/(dashboard)/dashboard/teacher/classrooms/[classId]/page.tsx:164` - Quiz data
14. `src/app/(dashboard)/dashboard/admin/page.tsx:93` - Auth user lookup

### Implementation Strategy
1. Create proper TypeScript interfaces for database types
2. Use Supabase's generated types where possible
3. Define strict types for API responses
4. Add proper type guards and narrowing
5. Enable `strict` mode in tsconfig if not already enabled

---

## Phase 3: Security Hardening (Week 3-4)

### Rate Limiting

**Target Endpoints:**
- `/api/convert-epub` - EPUB conversion (expensive operation)
- `/api/convert-mobi` - MOBI conversion (expensive operation)
- `/auth/callback` - Authentication callback
- All quiz generation endpoints
- File upload endpoints

**Implementation:**
- Use `@vercel/edge-config` or `upstash/ratelimit` for edge runtime
- Implement middleware for API route protection
- Set appropriate limits:
  - File conversions: 5 requests per 15 minutes per IP
  - Quiz generation: 10 requests per hour per user
  - Auth endpoints: 10 requests per 5 minutes per IP
  - Standard API: 100 requests per minute per user

### CAPTCHA Protection

**Target Pages:**
- Login page (`/login`)
- Signup page (`/signup`)
- Password reset page

**Implementation:**
- Use Cloudflare Turnstile (free, privacy-focused alternative to reCAPTCHA)
- Add CAPTCHA verification to auth endpoints
- Implement graceful fallback if CAPTCHA service is down
- Add environment variables for CAPTCHA keys

### Additional Security
- [ ] Add CSRF token validation for sensitive actions
- [ ] Implement request signature verification for webhooks
- [ ] Add input sanitization for all user inputs
- [ ] Implement SQL injection prevention (already handled by Supabase, but validate)
- [ ] Add XSS protection headers
- [ ] Implement Content Security Policy (CSP)

---

## Phase 4: Error Handling & UX (Week 4)

### Error Handling Improvements
- [ ] Create centralized error handling utilities
- [ ] Add user-friendly error messages
- [ ] Implement error boundary components
- [ ] Add proper error logging (consider Sentry integration)
- [ ] Handle network failures gracefully
- [ ] Add retry logic for failed operations

### Loading States
- [ ] Add skeleton loaders for data fetching
- [ ] Implement progress indicators for long operations
- [ ] Add optimistic UI updates where appropriate

---

## Implementation Checklist

### Week 1: Testing Foundation
- [ ] Install Vitest and React Testing Library
- [ ] Configure test environment
- [ ] Write first 10 unit tests
- [ ] Set up CI/CD test pipeline
- [ ] Document testing guidelines

### Week 2: Core Tests + TypeScript (Part 1)
- [ ] Write 20 more tests (30 total)
- [ ] Fix 7 high-priority `any` types
- [ ] Add database type definitions
- [ ] Test authentication flows

### Week 3: Security + TypeScript (Part 2)
- [ ] Implement rate limiting middleware
- [ ] Add CAPTCHA to auth pages
- [ ] Fix remaining 7 `any` types
- [ ] Write integration tests for API routes

### Week 4: Polish & Documentation
- [ ] Reach 60%+ test coverage
- [ ] Complete error handling improvements
- [ ] Add security headers
- [ ] Update documentation
- [ ] Create v1.3.0 release

---

## Success Metrics

### Testing
- ✅ 60%+ code coverage
- ✅ All critical paths tested
- ✅ CI/CD pipeline passing
- ✅ Zero broken tests in main branch

### Type Safety
- ✅ Zero TypeScript `any` types
- ✅ Strict mode enabled
- ✅ No type errors in build

### Security
- ✅ Rate limiting on all expensive endpoints
- ✅ CAPTCHA on authentication pages
- ✅ Security headers configured
- ✅ No critical security warnings

### Code Quality
- ✅ ESLint passing with zero warnings
- ✅ Improved error messages
- ✅ Better loading states
- ✅ Documentation updated

---

## Risk Assessment

### Low Risk
- Adding tests (doesn't affect production)
- Fixing TypeScript types (compile-time only)
- Adding error handling (improves stability)

### Medium Risk
- Rate limiting (could affect legitimate users if misconfigured)
- CAPTCHA (could impact UX if too aggressive)

### Mitigation Strategies
- Test rate limits thoroughly in staging
- Make rate limits configurable via environment variables
- Add admin bypass for rate limits
- Implement CAPTCHA only on high-risk endpoints
- Monitor rate limit hits and adjust thresholds
- Add comprehensive logging for security events

---

## Dependencies

### New Packages to Install
```json
{
  "devDependencies": {
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.0.0",
    "@testing-library/user-event": "^14.0.0",
    "@vitejs/plugin-react": "^4.2.0",
    "jsdom": "^23.0.0"
  },
  "dependencies": {
    "@upstash/ratelimit": "^1.0.0",
    "@upstash/redis": "^1.0.0",
    "@hcaptcha/react-hcaptcha": "^1.10.0"
  }
}
```

---

## Timeline

| Week | Focus | Deliverables |
|------|-------|--------------|
| 1 | Testing Setup | Testing infrastructure, first 10 tests |
| 2 | Tests + Types | 30 total tests, 7 `any` types fixed |
| 3 | Security | Rate limiting, CAPTCHA, remaining types |
| 4 | Polish | 60% coverage, documentation, release |

---

## Notes

- This is a **stability release** - no new features
- Focus on **code quality over quantity**
- All changes should be **backward compatible**
- Deploy to staging first, then production after thorough testing
- Monitor error rates and performance metrics after deployment

---

**Next Steps:**
1. Review and approve this plan
2. Set up feature branch: `feature/v1.3-polish-stability`
3. Begin Week 1 implementation
4. Weekly progress reviews

**Maintainer:** Faisal Nur Hidayat  
**Last Updated:** November 25, 2025
